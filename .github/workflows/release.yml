name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (do not create release)"
        required: false
        default: "true"
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify tag matches crate versions
        run: python3 scripts/verify_release_versions.py

  perf-fullscale-gate:
    name: Full-Scale Perf Gate
    needs: validate-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run full-scale perf suite
        if: ${{ github.event_name != 'workflow_dispatch' }}
        run: python scripts/check_perf_thresholds.py --suite full-scale --parallel --require-baseline --baseline benchmarks/baselines/full-scale.json --export-csv benchmarks/latest_fullscale.csv --export-json benchmarks/latest_fullscale.json

      - name: Compare perf results
        if: ${{ github.event_name != 'workflow_dispatch' }}
        run: python scripts/compare_perf_results.py benchmarks/baselines/full-scale.json benchmarks/latest_fullscale.json

      - name: Upload perf artifacts
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: perf-fullscale
          path: |
            benchmarks/latest_fullscale.csv
            benchmarks/latest_fullscale.json

  build-windows:
    if: ${{ github.event_name != 'workflow_dispatch' }}
    needs: [validate-release, perf-fullscale-gate]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Build release binary
        shell: bash
        run: cargo build --profile release-cli --locked -p tabulensis-cli

      - name: Create standalone EXE
        shell: bash
        run: |
          cp target/release-cli/tabulensis.exe tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.exe
          cp tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.exe tabulensis-latest-windows-x86_64.exe

      - name: Create ZIP archive
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"

          New-Item -ItemType Directory -Force -Path staging | Out-Null
          $stageDir = "staging/tabulensis-$version-windows-x86_64"
          New-Item -ItemType Directory -Force -Path $stageDir | Out-Null

          Copy-Item -Force "target/release-cli/tabulensis.exe" "$stageDir/tabulensis.exe"
          Copy-Item -Force "README.md" "$stageDir/README.md"
          Copy-Item -Force "LICENSE.txt" "$stageDir/LICENSE.txt"
          Copy-Item -Force "THIRD_PARTY_NOTICES.txt" "$stageDir/THIRD_PARTY_NOTICES.txt"

          Compress-Archive -Path $stageDir -DestinationPath "tabulensis-$version-windows-x86_64.zip"
          Copy-Item -Force "tabulensis-$version-windows-x86_64.zip" "tabulensis-latest-windows-x86_64.zip"

      - name: Compute SHA256
        shell: bash
        run: |
          sha256sum tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.zip > tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.zip.sha256
          sha256sum tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.exe > tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.exe.sha256
          sha256sum tabulensis-latest-windows-x86_64.zip > tabulensis-latest-windows-x86_64.zip.sha256
          sha256sum tabulensis-latest-windows-x86_64.exe > tabulensis-latest-windows-x86_64.exe.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: |
            tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.exe
            tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.exe.sha256
            tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.zip
            tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.zip.sha256
            tabulensis-latest-windows-x86_64.exe
            tabulensis-latest-windows-x86_64.exe.sha256
            tabulensis-latest-windows-x86_64.zip
            tabulensis-latest-windows-x86_64.zip.sha256

  build-macos-x64:
    needs: [validate-release, perf-fullscale-gate]
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Build release binary
        run: cargo build --profile release-cli --locked -p tabulensis-cli

      - name: Create tarball
        run: |
          mkdir -p staging
          cp target/release-cli/tabulensis staging/
          cp README.md staging/
          cp LICENSE.txt staging/
          cp THIRD_PARTY_NOTICES.txt staging/
          tar -czvf tabulensis-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz -C staging .

      - name: Compute SHA256
        run: |
          shasum -a 256 tabulensis-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz > tabulensis-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: |
            tabulensis-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz
            tabulensis-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz.sha256

      - name: Upload raw binary for universal
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-binary
          path: target/release-cli/tabulensis

  build-macos-arm64:
    needs: [validate-release, perf-fullscale-gate]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Build release binary
        run: cargo build --profile release-cli --locked -p tabulensis-cli

      - name: Create tarball
        run: |
          mkdir -p staging
          cp target/release-cli/tabulensis staging/
          cp README.md staging/
          cp LICENSE.txt staging/
          cp THIRD_PARTY_NOTICES.txt staging/
          tar -czvf tabulensis-${{ steps.version.outputs.version }}-macos-arm64.tar.gz -C staging .

      - name: Compute SHA256
        run: |
          shasum -a 256 tabulensis-${{ steps.version.outputs.version }}-macos-arm64.tar.gz > tabulensis-${{ steps.version.outputs.version }}-macos-arm64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            tabulensis-${{ steps.version.outputs.version }}-macos-arm64.tar.gz
            tabulensis-${{ steps.version.outputs.version }}-macos-arm64.tar.gz.sha256

      - name: Upload raw binary for universal
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-binary
          path: target/release-cli/tabulensis

  build-macos-universal:
    runs-on: macos-14
    needs: [build-macos-x64, build-macos-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Download x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-binary
          path: x86_64

      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-binary
          path: arm64

      - name: Create universal binary
        run: |
          lipo -create x86_64/tabulensis arm64/tabulensis -output tabulensis
          file tabulensis
          codesign -s - tabulensis

      - name: Create tarball
        run: |
          mkdir -p staging
          cp tabulensis staging/
          cp README.md staging/
          cp LICENSE.txt staging/
          cp THIRD_PARTY_NOTICES.txt staging/
          tar -czvf tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz -C staging .
          cp tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz tabulensis-latest-macos-universal.tar.gz

      - name: Compute SHA256
        run: |
          shasum -a 256 tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz > tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz.sha256
          shasum -a 256 tabulensis-latest-macos-universal.tar.gz > tabulensis-latest-macos-universal.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: |
            tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz
            tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz.sha256
            tabulensis-latest-macos-universal.tar.gz
            tabulensis-latest-macos-universal.tar.gz.sha256

  build-linux-x86_64:
    needs: [validate-release, perf-fullscale-gate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Build release binary
        run: cargo build --profile release-cli --locked -p tabulensis-cli

      - name: Create tarball
        run: |
          mkdir -p staging
          cp target/release-cli/tabulensis staging/
          cp README.md staging/
          cp LICENSE.txt staging/
          cp THIRD_PARTY_NOTICES.txt staging/
          tar -czvf tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz -C staging .
          cp tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz tabulensis-latest-linux-x86_64.tar.gz

      - name: Compute SHA256
        run: |
          sha256sum tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz > tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz.sha256
          sha256sum tabulensis-latest-linux-x86_64.tar.gz > tabulensis-latest-linux-x86_64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: |
            tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz
            tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz.sha256
            tabulensis-latest-linux-x86_64.tar.gz
            tabulensis-latest-linux-x86_64.tar.gz.sha256

  smoke-macos-sequoia:
    name: Smoke Test (macOS Sequoia)
    runs-on: macos-15
    needs: [build-macos-universal]
    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install fixture generator deps
        run: python -m pip install -r fixtures/requirements.txt

      - name: Install fixture generator
        run: python -m pip install -e fixtures --no-deps

      - name: Generate smoke fixtures
        run: generate-fixtures --manifest fixtures/manifest_release_smoke.yaml --force --clean

      - name: Download macOS universal artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-universal
          path: artifacts/macos

      - name: Run smoke checks
        run: |
          set -euo pipefail

          TARBALL=$(ls artifacts/macos/tabulensis-*-macos-universal.tar.gz | head -n 1)
          mkdir -p staging
          tar -xzf "$TARBALL" -C staging
          chmod +x staging/tabulensis

          staging/tabulensis --version
          staging/tabulensis --help >/dev/null
          staging/tabulensis diff fixtures/generated/minimal.xlsx fixtures/generated/minimal.xlsx --format json >/dev/null

          set +e
          staging/tabulensis diff fixtures/generated/col_append_right_a.xlsx fixtures/generated/col_append_right_b.xlsx >/dev/null
          STATUS=$?
          set -e
          if [ "$STATUS" -ne 1 ]; then
            echo "Expected exit code 1 for differing files, got $STATUS"
            exit 1
          fi

  generate-manifests:
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos-universal]
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "version_num=${VERSION#v}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
            echo "version_num=0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-x86_64
          path: artifacts/windows

      - name: Download macOS universal artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-universal
          path: artifacts/macos

      - name: Extract checksums
        id: checksums
        run: |
          WINDOWS_SHA=$(cat artifacts/windows/tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.zip.sha256 | awk '{print $1}')
          MACOS_SHA=$(cat artifacts/macos/tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz.sha256 | awk '{print $1}')
          echo "windows_sha=$WINDOWS_SHA" >> $GITHUB_OUTPUT
          echo "macos_sha=$MACOS_SHA" >> $GITHUB_OUTPUT

      - name: Generate Scoop manifest
        run: |
          cat > tabulensis.json << 'EOF'
          {
            "version": "${{ steps.version.outputs.version_num }}",
            "description": "Tabulensis CLI (compare Excel workbooks)",
            "homepage": "https://tabulensis.com",
            "license": "MIT",
            "architecture": {
              "64bit": {
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/tabulensis-${{ steps.version.outputs.version }}-windows-x86_64.zip",
                "hash": "${{ steps.checksums.outputs.windows_sha }}"
              }
            },
            "bin": "tabulensis-${{ steps.version.outputs.version }}-windows-x86_64/tabulensis.exe",
            "checkver": "github",
            "autoupdate": {
              "architecture": {
                "64bit": {
                  "url": "https://github.com/${{ github.repository }}/releases/download/v$version/tabulensis-v$version-windows-x86_64.zip"
                }
              }
            }
          }
          EOF

      - name: Generate Homebrew formula
        run: |
          cat > tabulensis.rb << 'EOF'
          class Tabulensis < Formula
            desc "Tabulensis CLI (compare Excel workbooks)"
            homepage "https://tabulensis.com"
            version "${{ steps.version.outputs.version_num }}"
            license "MIT"

            on_macos do
              url "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz"
              sha256 "${{ steps.checksums.outputs.macos_sha }}"
            end

            def install
              bin.install "tabulensis"
            end

            test do
              system "#{bin}/tabulensis", "--version"
            end
          end
          EOF

      - name: Upload manifests
        uses: actions/upload-artifact@v4
        with:
          name: manifests
          path: |
            tabulensis.json
            tabulensis.rb

  publish-release:
    runs-on: ubuntu-latest
    needs:
      - build-windows
      - build-macos-x64
      - build-macos-arm64
      - build-macos-universal
      - build-linux-x86_64
      - smoke-macos-sequoia
      - generate-manifests
      - perf-fullscale-gate
    if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.dry_run != 'true'
    permissions:
      contents: write
    steps:
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create checksums file
        run: |
          cd artifacts
          cat windows-x86_64/*.sha256 >> checksums.txt
          cat macos-x86_64/*.sha256 >> checksums.txt
          cat macos-arm64/*.sha256 >> checksums.txt
          cat macos-universal/*.sha256 >> checksums.txt
          cat linux-x86_64/*.sha256 >> checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            artifacts/windows-x86_64/tabulensis-*.exe
            artifacts/windows-x86_64/tabulensis-*.zip
            artifacts/macos-x86_64/tabulensis-*.tar.gz
            artifacts/macos-arm64/tabulensis-*.tar.gz
            artifacts/macos-universal/tabulensis-*.tar.gz
            artifacts/linux-x86_64/tabulensis-*.tar.gz
            artifacts/manifests/tabulensis.json
            artifacts/manifests/tabulensis.rb
            artifacts/checksums.txt
          body: |
            ## Installation

            ### Windows
            Download the ZIP (recommended) or the standalone `.exe` and add it to your PATH.

            Or use Scoop (manifest from this Release):
            ```powershell
            # 1) Download `tabulensis.json` from the Release assets
            # 2) Install:
            scoop install .\tabulensis.json
            ```

            ### macOS
            Using Homebrew (formula from this Release):
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/tabulensis.rb
            brew install --formula ./tabulensis.rb
            ```

            Or download the universal binary:
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz
            tar -xzf tabulensis-${{ steps.version.outputs.version }}-macos-universal.tar.gz
            sudo mv tabulensis /usr/local/bin/
            ```

            ### Linux
            Download and install the x86_64 tarball:
            ```bash
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz
            tar -xzf tabulensis-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz
            sudo mv tabulensis /usr/local/bin/
            ```

            ### Web Demo
            Try it in your browser at https://tabulensis.com

            ## Format Support
            - Supported: `.xlsx`, `.xlsm`, `.xltx`, `.xltm`, `.pbix`, `.pbit`
            - Unsupported (detected): `.xlsb` returns `EXDIFF_PKG_009` with a convert hint

            ## Permission bindings
            - DPAPI-encrypted permission bindings that cannot be validated default permissions and emit warning `EXDIFF_DM_009` (results may be marked incomplete).

            ## Checksums
            See `checksums.txt` for SHA256 hashes of all artifacts.

      - name: Upload latest assets to R2 (optional)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_DOWNLOAD_BUCKET: ${{ secrets.R2_DOWNLOAD_BUCKET }}
        run: |
          set -euo pipefail

          if [[ -z "${CLOUDFLARE_API_TOKEN:-}" || -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]]; then
            echo "Skipping R2 upload: CLOUDFLARE_API_TOKEN and/or CLOUDFLARE_ACCOUNT_ID not set."
            exit 0
          fi

          bucket="${R2_DOWNLOAD_BUCKET:-tabulensis-downloads}"

          upload() {
            local file="$1"
            local key
            key="$(basename "${file}")"

            local ct="application/octet-stream"
            if [[ "${key}" == *.zip ]]; then
              ct="application/zip"
            elif [[ "${key}" == *.tar.gz ]]; then
              ct="application/gzip"
            elif [[ "${key}" == *.sha256 ]]; then
              ct="text/plain; charset=utf-8"
            fi

            echo "Uploading ${key} -> r2://${bucket}/${key}"
            npx wrangler r2 object put "${bucket}/${key}" --file "${file}" --remote --content-type "${ct}" >/dev/null
          }

          upload "artifacts/windows-x86_64/tabulensis-latest-windows-x86_64.exe"
          upload "artifacts/windows-x86_64/tabulensis-latest-windows-x86_64.exe.sha256"
          upload "artifacts/windows-x86_64/tabulensis-latest-windows-x86_64.zip"
          upload "artifacts/windows-x86_64/tabulensis-latest-windows-x86_64.zip.sha256"
          upload "artifacts/macos-universal/tabulensis-latest-macos-universal.tar.gz"
          upload "artifacts/macos-universal/tabulensis-latest-macos-universal.tar.gz.sha256"
          upload "artifacts/linux-x86_64/tabulensis-latest-linux-x86_64.tar.gz"
          upload "artifacts/linux-x86_64/tabulensis-latest-linux-x86_64.tar.gz.sha256"
