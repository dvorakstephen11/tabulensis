name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not create release)'
        required: false
        default: 'true'
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify tag matches crate versions
        run: python3 scripts/verify_release_versions.py

  build-windows:
    needs: validate-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release --locked -p excel_diff_cli

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Create standalone EXE
        shell: bash
        run: |
          cp target/release/excel-diff.exe excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.exe

      - name: Create package directory
        shell: bash
        run: |
          mkdir -p staging/excel-diff-${{ steps.version.outputs.version }}-windows-x86_64
          cp target/release/excel-diff.exe staging/excel-diff-${{ steps.version.outputs.version }}-windows-x86_64/
          cp README.md staging/excel-diff-${{ steps.version.outputs.version }}-windows-x86_64/

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path staging/excel-diff-${{ steps.version.outputs.version }}-windows-x86_64 -DestinationPath excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.zip

      - name: Compute SHA256
        shell: bash
        run: |
          sha256sum excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.zip > excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.zip.sha256
          sha256sum excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.exe > excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.exe.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: |
            excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.exe
            excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.exe.sha256
            excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.zip
            excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.zip.sha256

  build-macos-x64:
    needs: validate-release
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release --locked -p excel_diff_cli

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Create tarball
        run: |
          mkdir -p staging
          cp target/release/excel-diff staging/
          cp README.md staging/
          tar -czvf excel-diff-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz -C staging .

      - name: Compute SHA256
        run: |
          shasum -a 256 excel-diff-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz > excel-diff-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: |
            excel-diff-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz
            excel-diff-${{ steps.version.outputs.version }}-macos-x86_64.tar.gz.sha256

      - name: Upload raw binary for universal
        uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-binary
          path: target/release/excel-diff

  build-macos-arm64:
    needs: validate-release
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release --locked -p excel_diff_cli

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Create tarball
        run: |
          mkdir -p staging
          cp target/release/excel-diff staging/
          cp README.md staging/
          tar -czvf excel-diff-${{ steps.version.outputs.version }}-macos-arm64.tar.gz -C staging .

      - name: Compute SHA256
        run: |
          shasum -a 256 excel-diff-${{ steps.version.outputs.version }}-macos-arm64.tar.gz > excel-diff-${{ steps.version.outputs.version }}-macos-arm64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            excel-diff-${{ steps.version.outputs.version }}-macos-arm64.tar.gz
            excel-diff-${{ steps.version.outputs.version }}-macos-arm64.tar.gz.sha256

      - name: Upload raw binary for universal
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-binary
          path: target/release/excel-diff

  build-macos-universal:
    runs-on: macos-14
    needs: [build-macos-x64, build-macos-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Download x86_64 binary
        uses: actions/download-artifact@v4
        with:
          name: macos-x86_64-binary
          path: x86_64

      - name: Download arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-binary
          path: arm64

      - name: Create universal binary
        run: |
          lipo -create x86_64/excel-diff arm64/excel-diff -output excel-diff
          file excel-diff
          codesign -s - excel-diff

      - name: Create tarball
        run: |
          mkdir -p staging
          cp excel-diff staging/
          cp README.md staging/
          tar -czvf excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz -C staging .

      - name: Compute SHA256
        run: |
          shasum -a 256 excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz > excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz.sha256
          cat excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: |
            excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz
            excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz.sha256

  smoke-macos-sequoia:
    name: Smoke Test (macOS Sequoia)
    runs-on: macos-15
    needs: [build-macos-universal]
    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install fixture generator deps
        run: python -m pip install -r fixtures/requirements.txt

      - name: Install fixture generator
        run: python -m pip install -e fixtures --no-deps

      - name: Generate smoke fixtures
        run: generate-fixtures --manifest fixtures/manifest_release_smoke.yaml --force --clean

      - name: Download macOS universal artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-universal
          path: artifacts/macos

      - name: Run smoke checks
        run: |
          set -euo pipefail

          TARBALL=$(ls artifacts/macos/excel-diff-*-macos-universal.tar.gz | head -n 1)
          mkdir -p staging
          tar -xzf "$TARBALL" -C staging
          chmod +x staging/excel-diff

          staging/excel-diff --version
          staging/excel-diff --help >/dev/null
          staging/excel-diff diff fixtures/generated/minimal.xlsx fixtures/generated/minimal.xlsx --format json >/dev/null

          set +e
          staging/excel-diff diff fixtures/generated/col_append_right_a.xlsx fixtures/generated/col_append_right_b.xlsx >/dev/null
          STATUS=$?
          set -e
          if [ "$STATUS" -ne 1 ]; then
            echo "Expected exit code 1 for differing files, got $STATUS"
            exit 1
          fi

  generate-manifests:
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos-universal]
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "version_num=${VERSION#v}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
            echo "version_num=0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-x86_64
          path: artifacts/windows

      - name: Download macOS universal artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-universal
          path: artifacts/macos

      - name: Extract checksums
        id: checksums
        run: |
          WINDOWS_SHA=$(cat artifacts/windows/*.zip.sha256 | awk '{print $1}')
          MACOS_SHA=$(cat artifacts/macos/*.tar.gz.sha256 | awk '{print $1}')
          echo "windows_sha=$WINDOWS_SHA" >> $GITHUB_OUTPUT
          echo "macos_sha=$MACOS_SHA" >> $GITHUB_OUTPUT

      - name: Generate Scoop manifest
        run: |
          cat > excel-diff.json << EOF
          {
            "version": "${{ steps.version.outputs.version_num }}",
            "description": "A tool for comparing Excel workbooks",
            "homepage": "https://github.com/dvora/excel_diff",
            "license": "MIT",
            "architecture": {
              "64bit": {
                "url": "https://github.com/dvora/excel_diff/releases/download/${{ steps.version.outputs.version }}/excel-diff-${{ steps.version.outputs.version }}-windows-x86_64.zip",
                "hash": "${{ steps.checksums.outputs.windows_sha }}"
              }
            },
            "bin": "excel-diff-${{ steps.version.outputs.version }}-windows-x86_64/excel-diff.exe",
            "checkver": "github",
            "autoupdate": {
              "architecture": {
                "64bit": {
                  "url": "https://github.com/dvora/excel_diff/releases/download/v\$version/excel-diff-v\$version-windows-x86_64.zip"
                }
              }
            }
          }
          EOF

      - name: Generate Homebrew formula
        run: |
          cat > excel-diff.rb << 'EOF'
          class ExcelDiff < Formula
            desc "A tool for comparing Excel workbooks"
            homepage "https://github.com/dvora/excel_diff"
            version "${{ steps.version.outputs.version_num }}"
            license "MIT"

            on_macos do
              url "https://github.com/dvora/excel_diff/releases/download/${{ steps.version.outputs.version }}/excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz"
              sha256 "${{ steps.checksums.outputs.macos_sha }}"
            end

            def install
              bin.install "excel-diff"
            end

            test do
              system "#{bin}/excel-diff", "--version"
            end
          end
          EOF

      - name: Upload manifests
        uses: actions/upload-artifact@v4
        with:
          name: manifests
          path: |
            excel-diff.json
            excel-diff.rb

  publish-release:
    runs-on: ubuntu-latest
    needs:
      - build-windows
      - build-macos-x64
      - build-macos-arm64
      - build-macos-universal
      - smoke-macos-sequoia
      - generate-manifests
    if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.dry_run != 'true'
    permissions:
      contents: write
    steps:
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create checksums file
        run: |
          cd artifacts
          cat windows-x86_64/*.sha256 >> checksums.txt
          cat macos-x86_64/*.sha256 >> checksums.txt
          cat macos-arm64/*.sha256 >> checksums.txt
          cat macos-universal/*.sha256 >> checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            artifacts/windows-x86_64/excel-diff-*.exe
            artifacts/windows-x86_64/excel-diff-*.zip
            artifacts/macos-x86_64/excel-diff-*.tar.gz
            artifacts/macos-arm64/excel-diff-*.tar.gz
            artifacts/macos-universal/excel-diff-*.tar.gz
            artifacts/manifests/excel-diff.json
            artifacts/manifests/excel-diff.rb
            artifacts/checksums.txt
          body: |
            ## Installation

            ### Windows
            Download the standalone `.exe` (or the ZIP) and add it to your PATH.

            Or use Scoop (manifest from this Release):
            ```powershell
            # 1) Download `excel-diff.json` from the Release assets
            # 2) Install:
            scoop install .\excel-diff.json

            # Or, if you publish a Scoop bucket:
            # scoop bucket add excel-diff https://github.com/dvora/scoop-excel-diff
            # scoop install excel-diff
            ```

            ### macOS
            Using Homebrew (formula from this Release):
            ```bash
            curl -LO https://github.com/dvora/excel_diff/releases/download/${{ steps.version.outputs.version }}/excel-diff.rb
            brew install --formula ./excel-diff.rb

            # Or, if you publish a Homebrew tap:
            # brew tap dvora/excel-diff
            # brew install excel-diff
            ```

            Or download the universal binary:
            ```bash
            curl -LO https://github.com/dvora/excel_diff/releases/download/${{ steps.version.outputs.version }}/excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz
            tar -xzf excel-diff-${{ steps.version.outputs.version }}-macos-universal.tar.gz
            sudo mv excel-diff /usr/local/bin/
            ```

            ### Web Demo
            Try it in your browser at https://dvora.github.io/excel_diff

            ## Format Support
            - Supported: `.xlsx`, `.xlsm`, `.xltx`, `.xltm`, `.pbix`, `.pbit`
            - Unsupported (detected): `.xlsb` returns `EXDIFF_PKG_009` with a convert hint

            ## Permission bindings
            - DPAPI-encrypted permission bindings that cannot be validated default permissions and emit warning `EXDIFF_DM_009` (results may be marked incomplete).

            ## Checksums
            See `checksums.txt` for SHA256 hashes of all artifacts.

