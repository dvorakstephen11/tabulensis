work_type: milestone_progress
branch_name: 2025-12-07-d5-composite-db-keys
target_subsystem: database_mode_row_alignment_and_diff
milestones_advanced:
  - "Phase 4 – D5 Composite primary key (database mode) as defined in the testing plan"
rationale:
  - "Database Mode is one of the core differentiators of the product; current engine support and tests cover only explicit single-column keys (D1–D4 semantics) even though real-world tables frequently rely on composite keys. Implementing D5 closes this gap in the critical-path feature set."
  - "The testing plan defines D5 explicitly as 'Composite primary key' with requirements around new composite key pairs, non-key edits, and avoiding false matches, but there are currently no composite-key-focused tests in the Rust suite. Adding them turns an implicit assumption into an explicit contract."
  - "The existing implementation in `database_alignment.rs` (`KeyColumnSpec`, `KeyValue`, and `diff_table_by_key`) is already structured to support multi-column keys, but this is only lightly exercised via single-column cases. A targeted D5 cycle validates that design without requiring major new algorithms."
  - "This work is a natural continuation of the recent D1 database-mode work and the grid-alignment heavy lifting (G8–G13). It advances Phase 4 without entangling more complex features like duplicate key clusters (D6) or key inference (D8–D9)."
  - "Finishing D5 establishes a solid foundation for D6–D10: duplicate key clusters, key priority, and key inference all assume that multi-column key handling is correct and stable. Locking that in early reduces the risk of cascading refactors later."
risks_of_deferral:
  - "Database Mode demos would remain effectively limited to single-column keys, undercutting the value proposition for list-style reconciliations where compound keys are the norm (e.g., Country + CustomerID, Account + Date)."
  - "Bugs in the multi-column path (e.g., incorrect hashing or equality for composite keys, mishandling of key vs non-key columns) would not be surfaced until much later, when they are entangled with D6–D9 features and harder to debug."
  - "The testing plan’s Phase 4 database-mode milestones would remain partially implemented and unbalanced (D1 covered, D2–D4 partially covered, D5 missing), making it harder to track progress and reason about coverage."
  - "Downstream work on duplicate key clusters (D6) and mixed-mode sheets (D10) would have to assume correctness of composite key alignment without proof, increasing the chance of subtle correctness issues in cluster assembly and region segmentation."
references:
  - "excel_diff_testing_plan.md – Phase 4 database-mode milestones D1–D6, especially D5 Composite primary key."
  - "excel_diff_specification.md – Diff pipeline overview and Database Mode as a tabular stage in the pipeline."
  - "unified_grid_diff_algorithm_specification.md – Database Mode alignment (hash-join on keys, UC-17/UC-18) and database-mode use cases."
  - "core/src/lib.rs – `diff_grids_database_mode` fallback behavior and integration with `diff_grids`."
  - "core/src/database_alignment.rs – `KeyColumnSpec`, `KeyValue`, and `diff_table_by_key` implementation."
  - "core/tests/d1_database_mode_tests.rs – Existing D1 engine-level tests for single-column keys and duplicate-key fallback."
  - "excel_diff_product_differentiation_plan.md – Database Mode vs Spreadsheet Mode positioning and current engine status."
difficulty_estimate:
  value: 4
  scale: "1-10"
  reference_milestone_10: "Phase 4/5 endgame for database mode and grid performance: large-sheet adversarial DB-mode alignment (UC-19) plus P2 performance suites on 50K–500K row workloads with duplicate key clusters and mixed spreadsheet/database regions."
