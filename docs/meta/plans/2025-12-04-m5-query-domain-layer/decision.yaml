# docs/meta/plans/2025-12-04-m5-query-domain-layer/decision.yaml

work_type: milestone_progress
target_subsystem: datamashup_query_domain_layer_m5

rationale:
  - Milestone 5 (Domain layer: M queries & metadata API) is partially complete:
      * Section1.m splitting is implemented and tested via `parse_section_members` and `m_section_splitting_tests.rs` (M5.1). :contentReference[oaicite:0]{index=0}
      * PackageParts, Permissions, and Metadata IR plus `build_data_mashup` are implemented and tested (Milestone 4). 
      * The remaining M5 work (Query–metadata join and domain invariants) is not yet implemented.
  - The testing plan explicitly calls for an ergonomic `Query` domain type and a `Vec<Query>` builder, joining Section1 members to metadata by `SectionName/FormulaName` (M5.2–5.3). 
  - The M diff algorithms in the technical specification assume a domain-layer `Query` model (Section 5.3) and operate on it for query alignment and textual/semantic diffing (Section 10). Without it, Milestone 6 (Textual M diff) cannot be implemented cleanly. 
  - Product-wise, the differentiation plan emphasizes M-query diffing as a core advantage over incumbents; shipping even a textual M diff requires this domain layer to exist. 
  - The current code and tests already prove:
      * Metadata XML parsing including percent-decoding of `ItemPath` to `section_name`/`formula_name`. 
      * Section1 splitting yields ordered, shared-only `SectionMember` items.
    This makes the remaining join logic a well-scoped, low-ambiguity milestone.
  - Tackling the full grid alignment / database-mode diff (H1/H4) next would jump straight into the highest-risk algorithms; M5 is a moderate, well-defined step that unblocks the M diff vertical slice (Phase 3) while we’ve just finished heavy IR infrastructure work. 

risks_of_deferral:
  - Milestone 6 (Textual M diff engine) is blocked:
      * There is no domain-level `Query` list to align and diff.
      * Any attempt to implement M diffs now would either re-implement the join ad-hoc or diff raw Section1 text, creating technical debt and violating the architecture. 
  - Downstream features that depend on queries—rename detection, semantic M diff, workbook-level M scenarios—would all be forced to build their own fragile interpretation of Metadata+Section1 instead of sharing a single canonical model.
  - Tests and fixtures for M6 would necessarily “bake in” a temporary API, making later refactors more invasive (touching CLI/wire formats and frontends).
  - From a product perspective, we would continue to have good container and grid diff support but no visible Power Query story, weakening the MVP narrative versus tools that already compare sheet data. 

references:
  - excel_diff_testing_plan.md
    - Phase 2 – Milestone 4 (Permissions / Metadata) and Milestone 5 sections. 
  - excel_diff_specification.md
    - Section 4 (DataMashup semantics), Section 5.3 (Power Query model), Section 10 (M Query Diff algorithms). 
  - excel_diff_difficulty_analysis.md
    - H1/H4 risk descriptions motivating de-risking M-stack early without tackling full AST diff yet. :contentReference[oaicite:11]{index=11}
  - codebase_context.md
    - `datamashup.rs`, `datamashup_package.rs`, `m_section.rs`, `lib.rs` exports, existing M4 tests. 
  - development_history.txt
    - Branches 2025-12-03-m4-permissions-metadata and 2025-12-02c-m5-section1-splitting documenting current state. 

difficulty_estimate: 4  # On a 1–10 scale where H1 grid alignment / database-mode diff is 10
