branch: 2025-12-02-m5-section1-splitting
work_type: milestone_progress
target_subsystem: m_query_domain

rationale:
  - Milestone 5 ("Domain layer: M queries & metadata API") is completely unimplemented today: the Rust code stops at RawDataMashup framing and does not yet model queries, metadata, or Section1.m semantics. Progress on this milestone is required before Milestone 6 (textual M diff) can exist. 
  - The testing plan explicitly calls for Section1.m splitting as the first step of Milestone 5 (tests `parse_single_member_section`, `parse_multiple_members`, `tolerate_whitespace_comments` using `section_single_member.m` and `section_multiple_members.m`). Implementing this API and tests is a self-contained way to start M-domain work without yet pulling in Excel or Metadata XML. :contentReference[oaicite:1]{index=1}
  - The current implementation already has robust DataMashup framing (`RawDataMashup`, `open_data_mashup`) and fixtures for MS-QDEFF, but no way to interpret `/Formulas/Section1.m` beyond a raw text slice. This leaves a clear architectural gap between spec and code around M query representation. 
  - The risk ledger and difficulty analysis identify the M-language parser and semantic M diff as a major difficulty cluster; starting with a simple, well-tested Section1 splitter de-risks this area incrementally while keeping the cycle small. 
  - Recent cycles have focused heavily on grid IR, DiffOp JSON, row/column signatures, and sheet-level diff (PG1–PG6). The M side (Milestones 4–6) has not progressed beyond framing; to keep risk balanced across subsystems we should now invest in the M query pipeline. 

risks_of_deferral:
  - Textual M diff (Milestone 6) remains completely blocked: without a way to enumerate queries and their `expression_m` bodies, there is nothing to diff and the M side of the MVP cannot ship. 
  - Metadata XML tests in Milestone 4 and Milestone 5 (`metadata_formulas_match_section_members`, `metadata_join_simple`, `metadata_load_destinations`) depend on mapping Metadata `Formulas` entries to Section1 members. Deferring Section splitting delays those invariants and increases the risk of later surprises when wiring Metadata to queries. 
  - The longer the Section1 splitting API remains undefined, the higher the chance that ad-hoc parsing logic will leak into other parts of the codebase when developers need "just a quick way" to pull out query names. Centralizing this behavior now with tests reduces future refactor cost.
  - Grid diff and container parsing already have strong PG and integration coverage; continuing to add grid-only tests while the M domain remains at "raw bytes" increases architectural imbalance and leaves a major product differentiator (Power Query diff) under-tested.

references:
  - docs/rust_docs/excel_diff_testing_plan.md – Milestone 4 & 5 (Section1.m splitting, query–metadata join, domain invariants). 
  - docs/rust_docs/excel_diff_specification.md – DataMashup PackageParts and Metadata sections; textual M diff design (Section 4–5, 10.2). 
  - docs/rust_docs/unified_grid_diff_algorithm_specification.md – overall engine context and difficulty ranking (grid diff as hardest subsystem; M diff as another major cluster). 
  - docs/meta/development_history.txt – prior cycles focussed on container+grid IR, datamashup framing, row signatures, PG5/PG6 grid diff; no M-domain query layer yet. 
  - docs/rust_docs/excel_diff_meta_programming.md – planner role, decision records, and test-first cycle requirements. 

difficulty_estimate:
  score: 4
  scale: 10
  reference_hardest_milestone: "H1 – Advanced grid alignment + database mode (G8–G13, D1–D10) in unified_grid_diff_algorithm_specification"
  reasoning: >
    Implementing a line-oriented Section1.m splitter with a small error type and three unit tests is moderate but not trivial:
    we must define a stable API, handle whitespace/comments, and avoid painting ourselves into a corner for later AST-based M parsing.
    Compared to H1 (advanced grid alignment and database mode) and the full semantic M diff (AST + step model), this work is
    substantially simpler in both algorithmic complexity and performance constraints, but it touches a new subsystem and sets
    precedent for future M parsing, so it is not "easy boilerplate."
