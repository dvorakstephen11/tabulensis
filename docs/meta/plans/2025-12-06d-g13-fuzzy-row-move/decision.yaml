work_type: milestone_progress
target_subsystem: spreadsheet_grid_diff_row_alignment_and_move_detection
branch_name: 2025-12-06-g13-fuzzy-row-move
milestone: Phase4-G13-Fuzzy-Row-Block-Move

rationale:
  - Phase 4 spreadsheet-mode alignment is almost complete: G8–G12 row/column alignment and block move detection are implemented and tested; G13 (fuzzy move detection) is the remaining spreadsheet-mode grid milestone in this phase. Completing it materially advances Phase 4 toward closure. 
  - Current move detection only handles exact moves; any move with internal edits is reported as delete+insert plus cell edits (or just noisy cell edits). This fails UC‑12 / G13’s requirement to classify “move + small edits” as a `BlockMovedRows` operation with internal `CellEdited` ops. 
  - Fuzzy move detection for row blocks is central to the hardest risk area (H1 – grid alignment and move detection). Implementing G13 gives us an exercised path for similarity-based moves (Jaccard-style) and lays groundwork for later LAP/Hungarian-based matching used in database duplicate-key clusters. 
  - The required changes are well-localized: new fuzzy row-block detection in `core/src/row_alignment.rs` and an additional fast path in `core/src/engine.rs::diff_grids`, plus fixtures and tests. No public API changes are needed, which keeps the cycle small and aligned with the existing cascading diff pipeline. 
  - Locking in G13 tests now creates stable guardrails for future refactors towards the full AMR pipeline in `unified_grid_diff_algorithm_specification.md` (anchors, gap alignment, move validation). We can later replace the internals without changing observable behavior. 

risks_of_deferral:
  - User-visible quality: important “block moved and lightly edited” scenarios (UC‑12 / grid_move_and_edit) will continue to appear as large delete+insert regions or noisy positional diffs instead of a clean `BlockMovedRows` + small edit set, weakening the core Excel diff UX. :contentReference[oaicite:5]{index=5}
  - Architectural risk: database mode’s future duplicate-key handling and more advanced move semantics assume we already have a working similarity-based move primitive. Deferring G13 makes later integration of LAP-based matching riskier and more invasive. 
  - Testing blind spot: Phase 4 currently exercises exact block moves (rows, columns, rectangles) but not fuzzy moves. Without G13 tests, we lack coverage for similarity thresholds, ambiguity handling, and bail-out behavior under adversarial but near-duplicate grids. 
  - Potential rework: If we build more on top of the current exact-only move model (including downstream presentation/UI expectations) and only later introduce fuzzy moves, we may need to revisit existing assumptions and tests around operation ordering and classification.

references:
  - excel_diff_testing_plan.md: Phase 4 – Advanced alignment & DB mode (G8–G13, D1–D10) and UC‑12 / G13 description. 
  - unified_grid_diff_algorithm_specification.md: UC‑11–UC‑13 move detection, AMR Phase 4 move validation, fuzzy move similarity (Jaccard, 0.80 threshold). 
  - excel_diff_difficulty_analysis.md: H1 – Grid alignment and move detection as the top difficulty/risk area. :contentReference[oaicite:10]{index=10}
  - codebase_context.md: current exact row/column/rect block move detectors, guards (size, repetition, low-info), and the cascading `diff_grids` pipeline. 
  - development_history.txt: recent completion of G11/G12 and D1, leaving G13 as the next natural spreadsheet-mode milestone in Phase 4. 

difficulty_estimate:
  score: 7
  hardest_milestone: H1-full-grid-alignment-and-move-detection-at-scale
  notes: >
    Implementing G13 requires introducing similarity-based block matching on top
    of existing hash/meta structures and integrating it into the move pipeline
    with cautious ambiguity and performance guards. This is significantly harder
    than G8–G12 but still a scoped subset of the full AMR + LAPJV design,
    hence rated 7/10 relative to the full H1 milestone.

