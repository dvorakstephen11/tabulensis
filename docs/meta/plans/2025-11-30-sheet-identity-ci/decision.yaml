# docs/meta/plans/2025-11-30-sheet-identity-ci/decision.yaml

branch: 2025-11-30-sheet-identity-ci
work_type: incremental_milestone
target_subsystem: workbook_sheet_identity_and_engine_diff_workbooks
difficulty_estimate: 3  # 10 ~= full H1 grid diff (G8–G13 advanced alignment)

rationale:
  - The technical spec defines sheet identity as keyed by "(case-insensitive) name plus type" (SheetKind), but the current engine maps sheets by raw name string only, which is case-sensitive and ignores type. 
  - The docs-vs-implementation review calls this discrepancy out explicitly as D1 ("Sheet identity case-sensitive") and recommends fixing it *before* advanced grid diff work, so object-graph semantics are stable while the hard algorithms are built. 
  - `diff_workbooks` currently builds `HashMap<&str, &Sheet>` keyed on `Sheet.name`, then walks the union of keys; changing identity semantics to "(lowercased name, SheetKind)" can be localized to this function plus a small IR adjustment (`SheetKind: Hash`). 
  - All existing tests (PG1–PG4, engine, output, sparse grid, signatures) pass today; adding focused sheet-identity tests gives us a safety net to refactor the grid diff later without accidentally regressing naming behavior. 
  - This milestone is tightly scoped, externally observable (users no longer see spurious adds/removes for case-only sheet changes), and an enabler for later rename-detection and structural diff work, making it a good "small, testable" cycle.

risks_of_deferral:
  - If we implement advanced grid diff (AMR pipeline, G1–G7) on top of the current case-sensitive sheet mapping, we will bake incorrect identity semantics into a much more complex engine, making the eventual D1 fix riskier and harder to reason about. 
  - Users comparing workbooks where sheet names differ only by case (common when files move between environments or naming conventions change) will see misleading `SheetAdded`/`SheetRemoved` events instead of clean "no diff" or cell-level diffs, undermining trust in early MVPs.
  - Rename detection (future spec feature based on object signatures) assumes a correct identity baseline; leaving D1 unfixed could mean later tests around renames conflate "rename" with "case-normalization artifact". :contentReference[oaicite:5]{index=5}
  - As grid diff algorithms grow more sophisticated, any change to sheet identity will require touching more code paths (alignment caching, mode selection, reporting), increasing the chance of regressions.

references:
  - docs/excel_diff_specification.md §6–7 (diff pipeline and sheet/object identity) :contentReference[oaicite:6]{index=6}
  - docs/unified_grid_diff_algorithm_specification.md (pipeline context; not directly changed but depends on stable object identity) 
  - docs/2025-11-30-docs-vs-implementation.md (D1 discrepancy and recommended priority order) 
  - docs/excel_diff_testing_plan.md (Phase 3+ depend on object-graph correctness before advanced alignment) 
  - core/src/engine.rs (`diff_workbooks` implementation) :contentReference[oaicite:10]{index=10}
  - core/src/workbook.rs (`Sheet`, `SheetKind`) :contentReference[oaicite:11]{index=11}
  - core/tests/engine_tests.rs (current workbook-level diff tests) 

