branch_name: 2025-12-05-g9-column-alignment
work_type: milestone_progress
target_subsystem: spreadsheet_grid_diff_column_alignment

milestones:
  phase: 4
  primary:
    id: G9
    name: "Single column insert/delete in the middle (column alignment)"
  related:
    - id: G8
      name: "Single row insert/delete in the middle (row alignment)"
    - id: UC-08
      name: "Single column insert in middle – unified grid diff spec"

summary: >
  Extend the spreadsheet-mode grid diff engine with a small, well‑gated
  column-alignment path so that a single column inserted or deleted in the
  middle of a small sheet yields a clean ColumnAdded/ColumnRemoved with no
  spurious CellEdited noise, mirroring the existing G8 row-alignment behavior.

rationale:
  - >
    The testing plan defines G9 as “Single column insert/delete in the middle
    (column alignment)” with the expectation of a single ColumnAdded/ColumnRemoved
    and correctly aligned cells after the insertion/deletion. This capability is
    currently missing; mid-sheet column inserts still fall back to the positional
    PG5 baseline, which produces many CellEdited ops. :contentReference[oaicite:0]{index=0}
  - >
    The unified grid diff algorithm spec treats UC‑08 (“Single Column Insert in
    Middle”) as a must‑have alignment case, explicitly requiring a column mapping
    that ensures columns after the insertion are compared to their shifted
    counterparts with no spurious edits. Implementing a first column-alignment
    path for small grids directly advances this use case. 
  - >
    Recent work has already delivered the GridView/HashStats preprocessing layer
    and a small-grid row-alignment module (G8) integrated into diff_grids.
    Column metadata (ColMeta) is present but not yet used for alignment, so
    adding a first column-alignment path is a natural continuation that reuses
    the same infrastructure. 
  - >
    The difficulty analysis highlights “High-performance 2D grid diff (advanced
    row/column alignment, move detection, database-mode integration)” as one of
    the hardest items (H1). A safe, narrow G9 implementation lets us exercise
    column alignment and dimension-ordering ideas on a trivial case before
    tackling larger adversarial grids, moves, and database-mode interactions. 
  - >
    From a product differentiation perspective, correct handling of simple
    mid-sheet insertions is a visible quality bar: users expect that inserting a
    column for a new metric does not cause hundreds of unrelated “cell changed”
    entries. Locking in clean semantics for this case supports the roadmap’s
    emphasis on trustworthy, structure-aware grid diffs. :contentReference[oaicite:4]{index=4}
  - >
    The development history shows we now pass G1–G8 spreadsheet grid tests,
    PG1–PG6 workbook tests, and M6 textual M diffs. Progressing to G9 keeps the
    grid-diff track moving forward without opening new subsystems (PBIX, DB
    mode, AST diff) and stays aligned with the phased testing plan. 

risks_of_deferral:
  - >
    Mid-sheet column insert/delete will continue to produce noisy diffs with
    many CellEdited ops, undermining user trust precisely in the kind of simple
    “insert a metric column” workflow that should look clean.
  - >
    We would have row alignment (G8) but no corresponding column alignment,
    leaving the alignment subsystem asymmetric and making future dimension-order
    logic harder to reason about and test incrementally. 
  - >
    Column metadata (ColMeta) and HashStats are currently only exercised
    indirectly via tests; without an actual column-alignment consumer, bugs or
    design mismatches in ColMeta hashing/frequency analysis might remain latent
    until later, riskier milestones like block moves or database-mode column
    stability checks. 
  - >
    Deferring G9 pushes us toward tackling heavier milestones (G8a adversarial
    grids, G10+ block/move detection, D1–D10 database mode) without first
    validating that even the smallest column-change scenario behaves correctly,
    increasing integration risk for the H1 grid-alignment stack. 

references:
  - docs/rust_docs/excel_diff_testing_plan.md (Spreadsheet-mode advanced alignment G8–G9) :contentReference[oaicite:9]{index=9}
  - docs/rust_docs/unified_grid_diff_algorithm_specification.md (UC‑05, UC‑08, dimension ordering, column alignment) 
  - docs/rust_docs/excel_diff_specification.md – grid diff and DiffOp semantics (RowAdded/Removed, ColumnAdded/Removed). :contentReference[oaicite:11]{index=11}
  - docs/rust_docs/excel_diff_difficulty_analysis.md – H1: high‑performance 2D grid diff. :contentReference[oaicite:12]{index=12}
  - docs/rust_docs/excel_diff_product_differentiation_plan.md – emphasis on structure-aware grid alignment and moves. :contentReference[oaicite:13]{index=13}
  - docs/rust_docs/unified_grid_diff_algorithm_specification.md – GridView/HashStats and row/column metadata definitions. 
  - docs/meta/plans/2025-12-05b-gridview-layer1/spec.md (prior GridView layer spec – for continuity).
  - docs/meta/plans/2025-12-05c-g8-row-alignment/spec.md (row-alignment small-grid G8 spec – symmetry reference). :contentReference[oaicite:15]{index=15}
  - core/src/grid_view.rs, core/src/row_alignment.rs, core/src/engine.rs – current implementation context. 
  - core/tests/g5_g7_grid_workbook_tests.rs, core/tests/g8_row_alignment_grid_workbook_tests.rs – existing workbook-level grid diff tests. 

difficulty_estimate:
  score: 4
  scale_max: 10
  hardest_milestone: "Phase 4 – High-performance 2D grid diff (advanced row/column alignment, moves, database mode) [H1]"
  reasoning: >
    Implementing G9 for small, well‑gated spreadsheet grids reuses the existing
    GridView/HashStats and the single-row alignment design. It does not yet
    require full dimension ordering, block move detection, database mode, or
    adversarial perf handling. Compared to the full H1 scope (G8a, G10–G13,
    D1–D10, P1/P2), this is a moderate but tractable slice, primarily involving
    adding a ColumnAlignment helper, wiring it into diff_grids, and adding
    fixture-backed integration tests.