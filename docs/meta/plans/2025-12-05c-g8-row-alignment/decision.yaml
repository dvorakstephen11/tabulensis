# docs/meta/plans/2025-12-05-g8-row-alignment/decision.yaml

branch: 2025-12-05-g8-row-alignment

work_type: milestone_progress
target_subsystem: grid_diff_row_alignment

rationale:
  - Phase 3 grid milestones are covered: PG5/PG6 grid-diff tests and G1–G7 workbook-level grid scenarios exist and are passing, so the next planned work on the grid side is Phase 4 advanced alignment (G8+). 
  - The current grid diff implementation in core/src/engine.rs is purely positional: it compares overlapping rectangles row-for-row/col-for-col and only emits row/column add/remove operations at the sheet tail, so a single row insert/delete in the middle still surfaces as a block of incorrect CellEdited ops. 
  - The GridView + HashStats preprocessing layer and row/column signatures are now implemented and tested, but unused by diff_grids; the unified grid diff design explicitly calls for using these structures to drive anchor-based row alignment. Connecting them is the natural next step. 
  - The testing plan defines G8 (“single row inserted/deleted in the middle”) as the first spreadsheet‑mode advanced alignment milestone and ties it directly to the core user stories UC‑06/UC‑07, so delivering G8 behaviour is clear milestone progress with high product value. 
  - Difficulty analysis ranks the high‑performance 2D grid diff (alignment, moves, DB mode) as the top technical hurdle (H1); starting with a tightly-scoped G8 alignment slice de‑risks this area while keeping implementation manageable. 

risks_of_deferral:
  - Spreadsheet‑mode row inserts/deletes in the middle of a grid will continue to produce noisy, misleading diffs (large blocks of CellEdited plus tail row adds/removes) contrary to the product and testing specs, reducing trust in the tool for realistic use cases. 
  - GridView/HashStats will remain disconnected from the main diff pipeline, increasing the risk of architectural drift between the unified grid diff design and the engine implementation.
  - Deferring any alignment work keeps the highest‑risk subsystem (H1) untested in end‑to‑end scenarios, so later integration may surface surprises when the rest of the product is already more rigid.
  - Future database‑mode and mixed‑mode milestones (D1–D10) depend on having a solid spreadsheet‑mode alignment story; delaying G8 pushes those milestones back and compresses schedule risk later. 

references:
  - docs/rust_docs/excel_diff_testing_plan.md (Phase 4 – Advanced Alignment & DB Mode, G8–G8a, H1 mapping) 
  - docs/rust_docs/unified_grid_diff_algorithm_specification.md (GridView, frequency analysis, anchor-based alignment, AMR row alignment) 
  - docs/rust_docs/excel_diff_specification.md (grid diff & DiffOp semantics, spreadsheet vs database mode) :contentReference[oaicite:9]{index=9}
  - core/src/engine.rs (diff_workbooks, diff_grids positional baseline implementation) :contentReference[oaicite:10]{index=10}
  - core/src/grid_view.rs, core/tests/grid_view_tests.rs, core/tests/grid_view_hashstats_tests.rs (GridView + HashStats layer now implemented) 
  - core/tests/g1_g2_grid_workbook_tests.rs, core/tests/g5_g7_grid_workbook_tests.rs (current spreadsheet-mode workbook grid scenarios) 
  - docs/rust_docs/excel_diff_difficulty_analysis.md (H1 difficulty and prioritization) :contentReference[oaicite:13]{index=13}

difficulty_estimate:
  value: 7
  scale_10_definition: >
    10 = “Full H1 grid diff engine as specified in the unified grid diff design:
    complete spreadsheet+database alignment (G8–G13, D1–D10), including AMR,
    move detection, key inference, streaming/chunked mode, and perf regressions
    locked down via P1/P2 large-grid benchmarks.” 

linked_milestones:
  phase: 4
  primary:
    id: G8
    description: Single row inserted/deleted in the middle of a spreadsheet‑mode grid (UC‑06/UC‑07). 
  partial_coverage_notes:
    - This cycle targets the “small, clean” G8 scenarios (single unique row inserted or deleted in the middle, modest grid size).
    - Adversarial pattern coverage (G8a, highly repetitive 50k-row grids) and generalization to multiple inserts/deletes and moves are explicitly deferred to later cycles. 
