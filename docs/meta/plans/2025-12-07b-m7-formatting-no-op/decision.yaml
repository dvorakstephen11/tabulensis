branch: 2025-12-07-m7-formatting-no-op
work_type: milestone_progress
target_subsystem: semantic_m_diff_m7

rationale:
  - The M textual diff (M6) is fully implemented and tested, and an M AST module with canonicalization/equality now exists (M7 groundwork), but the main diff pipeline still ignores AST semantics and treats any textual change as DefinitionChanged. 
  - The testing plan’s Milestone 7 explicitly calls out a “formatting only” semantic milestone (M7.1), where canonicalized AST equality must suppress semantic changes for pretty-printed variants; current behavior fails this by surfacing noise for whitespace/comment-only edits. 
  - Product differentiation docs highlight semantic M diff as a core competitive advantage; wiring AST equality into the M diff engine is the smallest concrete step toward that goal that delivers end‑to‑end value and exercises the new AST module in realistic workflows. 
  - The grid engine has recently advanced through G8–G13 (row/column/rect moves) and database mode has keyed equality and composite-key handling (D1, D5), but M semantics remain the least mature high‑risk subsystem (H4) in the difficulty analysis. Tackling the lowest-hanging part of M7 reduces risk without requiring the full GumTree/APTED stack yet. 
  - AST canonicalization/equality is currently only validated via targeted unit tests; integrating it into diff_m_queries with fixtures-backed tests will flush out API gaps, performance issues, and parser limitations while the surface area is still small. 

risks_of_deferral:
  - Users continue to see noisy DefinitionChanged reports for formatting-only edits in M, undermining the engine’s “semantic diff” story and making it harder to demonstrate product value early.
  - The longer AST semantics remain unused by the main pipeline, the more likely they drift from the spec and from real-world query patterns; later integration would risk larger refactors and more subtle regressions.
  - M7 remains an untested gap at the pipeline level, leaving a major difficulty item (semantic M diff) at “foundation only” while other subsystems (grid alignment, database mode) mature, skewing the risk profile.
  - Future work on step-aware diff and GumTree/APTED (full M7) will be harder to validate without first having a simple, well-tested semantic-gating layer to compare against.

references:
  - docs/rust_docs/excel_diff_testing_plan.md (Milestone 6 and 7 – M diff, especially §“Milestone 7 – Semantic (AST) M diffing”) 
  - docs/rust_docs/excel_diff_specification.md (§10 M Query Diff Algorithms, especially 10.2 Textual Diff and 10.3.1 Canonicalization) 
  - core/src/m_diff.rs and core/tests/m6_textual_m_diff_tests.rs (current M6 textual diff behavior and invariants) 
  - core/src/m_ast.rs and core/tests/m7_ast_canonicalization_tests.rs (AST parsing, canonicalization, and equality plus formatting-only fixtures) 
  - fixtures/manifest.yaml – m_formatting_only_{a,b,b_variant}.xlsx entries (formatting-only and negative-control scenarios) :contentReference[oaicite:9]{index=9}
  - docs/rust_docs/excel_diff_product_differentiation_plan.md (semantic M diff as a key differentiator) :contentReference[oaicite:10]{index=10}
  - docs/rust_docs/excel_diff_difficulty_analysis.md (H4: Semantic M Diffing) :contentReference[oaicite:11]{index=11}

difficulty_estimate:
  value: 6
  scale: "10 = full H4 Semantic M diff engine (complete M7 including step-aware diff, GumTree+APTED integration, and large-query performance hardening)."
