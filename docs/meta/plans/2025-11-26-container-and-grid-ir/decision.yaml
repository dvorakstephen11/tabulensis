cycle_id: "2025-11-26-container-and-grid-ir"
date: "2025-11-26"

work_type: "milestone_progress"

target_subsystem:
  - "excel_container_open"
  - "workbook_sheet_grid_ir"
  - "addressing_helpers"

target_testing_milestones:
  # From testing blueprint
  - "Phase 1 – Milestone 1.1: Basic file opening"
  - "Phase 1 – Milestone 1.2: Is this a ZIP? (Excel container detection)"
  - "Phase 1 – PG1: Workbook → Sheet → Grid IR sanity"
  - "Phase 2 – PG2: Addressing and index invariants (A1 <-> (row,col))"

context:
  architecture_docs:
    - "excel_diff_specification.md"
    - "excel_diff_product_differentiation_plan.md"
  process_docs:
    - "excel_diff_meta_programming.md"
    - "excel_diff_testing_plan.md"
  risk_docs:
    - "excel_diff_difficulty_analysis.md"
  codebase_snapshot:
    - "review_prompt.md"

current_state_summary:
  rust_core:
    description: >
      The core crate `excel_diff` is a single binary with `main.rs` printing
      'Hello, world!'. There is no library module, no IR types, and no parsing
      or diff logic yet. One integration test only verifies that
      `fixtures/generated/minimal.xlsx` exists on disk.
    evidence:
      - "core/src/main.rs"        # hello world only
      - "core/tests/integration_test.rs"  # path-exists smoke test
  fixtures_repo:
    description: >
      The Python fixture generator and manifest are in good shape and already
      cover early milestones: container corruption, PG1 grid shapes, PG2
      addressing, PG3 cell types, basic M mashup corruption/injection, perf
      grids, and database-mode tables.
    key_scenarios:
      - "smoke_minimal -> minimal.xlsx"
      - "container_random_zip -> random_zip.zip"
      - "container_no_content_types -> no_content_types.xlsx"
      - "pg1_basic_two_sheets -> pg1_basic_two_sheets.xlsx"
      - "pg1_sparse -> pg1_sparse_used_range.xlsx"
      - "pg1_mixed -> pg1_empty_and_mixed_sheets.xlsx"
      - "pg2_addressing -> pg2_addressing_matrix.xlsx"
    evidence:
      - "fixtures/manifest.yaml"
      - "fixtures/src/generators/*.py"
  planned_architecture_vs_code:
    ir_gap: >
      The architecture doc defines a normalized IR for Workbook/Sheet/Grid/Cell
      with M and data-model hooks, but no corresponding Rust types exist yet,
      and no parsing path from Excel containers into that IR. 
    test_harness_gap: >
      The testing plan assumes Rust integration tests exercising real fixtures
      at PG1/PG2, but currently only the fixture path smoke test exists. 
    container_gap: >
      The testing plan’s Phase 1 milestones expect robust detection of Excel
      ZIP containers vs corrupted/foreign ZIPs, but the Rust side has no
      container logic yet. 

architecture_alignment_rationale:
  - >
    The technical blueprint assumes all higher-level algorithms (grid diff,
    database-mode diff, M/DAX diff) operate on a shared IR:
    `Workbook -> Sheet -> Grid -> Row -> Cell`. We need that IR in Rust,
    plus a real Excel parser, before any diff logic can be meaningfully
    implemented or tested. :contentReference[oaicite:3]{index=3}
  - >
    PG1/PG2 are explicitly designed to harden the IR semantics (sheet
    enumeration, used-range extents, and A1-addressing) early, which is
    crucial for the later high-difficulty grid alignment work (H1). 
  - >
    The meta process emphasizes small, test-driven cycles and tying each
    cycle to testing milestones; PG1/PG2 plus Milestones 1.1/1.2 are the
    smallest coherent “vertical slice” that delivers real value and unlocks
    later work. 

identified_gaps_and_drift:
  - id: "IR-001"
    description: >
      No Rust IR types exist for Workbook/Sheet/Grid/Cell, despite being
      defined in the technical blueprint. This blocks any diff implementation
      and risks ad hoc, inconsistent types being added later.
    consequence_if_ignored: >
      Future diff and parsing work will accrete around ad hoc structs,
      increasing refactor cost and risking deviation from the documented IR.
  - id: "CONTAINER-001"
    description: >
      No Excel container parsing or “is this a ZIP/OpenXML workbook?” logic
      exists, while fixtures and tests are already in place to exercise those
      behaviors.
    consequence_if_ignored: >
      We cannot validate robustness to corrupted containers or non-Excel
      inputs (e.g., random_zip.zip, no_content_types.xlsx), leaving a key
      failure mode untested. 
  - id: "HARNESS-001"
    description: >
      Rust tests currently hard-code fixture file names and do not use the
      manifest, diverging slightly from the intended “shared manifest” test
      harness design.
    consequence_if_ignored: >
      This is a minor drift; it doesn’t block functionality but will become
      awkward as the fixture set grows. We will not address it in this cycle
      to keep scope tight, but it should be cleaned up in a later refactor
      cycle. 

chosen_work_type: "milestone_progress"

milestone_progress_details:
  description: >
    Implement the first real Excel workbook parser and IR and wire it into
    integration tests for PG1 and PG2, plus container sanity tests for
    minimal.xlsx, random_zip.zip, and no_content_types.xlsx.
  completes_or_advances:
    - "Phase 1 Milestone 1.1: Basic file opening — from 0% to ~100%."
    - "Phase 1 Milestone 1.2: Is this a ZIP? — from 0% to ~100%."
    - "Phase 1 PG1: Workbook → Sheet → Grid IR sanity — from 0% to ~80–100%."
    - "Phase 2 PG2: Addressing and index invariants — from 0% to ~80–100%."

risks_of_deferring_this_work:
  - >
    All downstream diff capabilities (grid alignment, DB-mode diffs, M-query
    diffs) depend on having a stable Workbook/Sheet/Grid IR and reliable
    Excel container parsing. Deferring this work delays every other milestone.
  - >
    Without early PG1/PG2 tests, future changes may implicitly bake in
    incorrect assumptions about used ranges and cell addressing, which are
    very hard to change later without breaking user-facing behavior.
  - >
    Streaming and WASM compatibility are high-risk areas (H2). If we don’t
    establish a clean separation between “core IR + logic” and “host I/O”
    now, later refactors to support wasm32 and streaming will be more painful.
    

difficulty_estimate:
  hardest_milestone_name: "H1: High-performance 2D grid diff engine (Phase 4 G8–G12, D1–D10)"
  hardest_milestone_score: 10
  this_cycle_score: 3
  reasoning: >
    This cycle is mainly about plumbing (ZIP/OpenXML parsing) and bringing
    the documented IR into code, plus basic A1-addressing helpers. There is
    some conceptual design work, but we avoid the algorithmic heavy lifting
    (row/column alignment, move detection, database-mode matching) that make
    H1 hard. Complexity and performance constraints are modest because we
    only target small/medium fixtures, not 50k-row performance tests.

interfaces_allowed_to_change_later:
  - "The exact Workbook/Sheet/Grid struct field set (as long as we preserve semantics and can migrate)."
  - "The internal Excel container reader implementation (e.g., switching from a naive DOM-like approach to streaming)."
interfaces_expected_stable_after_this_cycle:
  - "Public IR type names and basic structure: Workbook, Sheet, SheetKind, Grid, Row, Cell, CellValue, CellAddress."
  - "Public function signature for loading a workbook from disk into the IR (e.g., open_workbook(path) -> Result<Workbook, ExcelOpenError>)."
  - "A1-addressing helpers: index_to_address, address_to_index, and CellAddress behavior."

notes_for_implementer_agent:
  - >
    Favor a minimal, correct implementation over streaming/perf cleverness.
    It is acceptable if the first version reads small/medium workbooks into
    memory eagerly, as long as the IR and error model match the spec and the
    code compiles for wasm32 (no OS-only APIs in shared modules).
  - >
    Keep the Excel-specific parsing confined to a clearly named module
    (e.g., excel_open_xml or excel_container) so we can swap implementations
    later without touching the IR or tests.
  - >
    Avoid introducing heavy dependencies that are known to be non-wasm
    friendly; use standard crates like `zip` / `quick-xml` style solutions
    rather than native COM bindings or platform-specific APIs.
