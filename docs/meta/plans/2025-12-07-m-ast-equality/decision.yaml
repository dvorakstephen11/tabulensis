# docs/meta/plans/2025-12-07-m-ast-equality/decision.yaml
work_type: incremental_milestone
branch_name: 2025-12-07-m-ast-equality
target_subsystem: m_ast_and_semantic_diff_foundation

rationale:
  - The current M pipeline stops at textual diff (Milestone 6); there is no AST or step model in the codebase yet, even though the IR spec expects `Query` to have `ast: MModuleAst` and `steps: Vec<MStep>` for semantic diff. 
  - Phase 4 of the testing plan calls for Milestone 7 (semantic AST M diffing), but that milestone assumes a working M parser and canonicalization layer, which are completely absent today. Jumping directly from M6 to full M7 would be too large for one cycle. 
  - Difficulty analysis flags both “H3 – M language parser & step model” and “H4 – Semantic M diff engine” as top‑tier risks (scores 15 and 16). They are still at “not started” maturity, while H1 grid diff (G8–G13, D1–D5) has recently seen multiple cycles of progress. It is time to de‑risk M parsing. 
  - The existing `Query` type in `datamashup.rs` only carries `name`, `section_member`, `expression_m`, and `metadata`; there is no place to hang parsed AST or step lists yet. Introducing an AST representation and equality function in a separate module lets us validate parsing and canonicalization semantics without destabilizing the M5/M6 API. 
  - Milestone 7’s first tests (“formatter round‑trip is a no‑op”) can be partially exercised with a simpler incremental milestone that only checks AST equality/canonicalization, without yet wiring semantic diff into `diff_m_queries` or `DiffOp`. This keeps the cycle small but advances Phase 4 in a meaningful, test‑driven way. 
  - The grid diff subsystem has just completed several advanced milestones (G8–G13 row/column alignment and moves, D1/D5 database‑mode keyed equality), so planning another heavy grid cycle now would push H3/H4 even further out and increase schedule risk for the core “semantic M diff” differentiator. 

risks_of_deferral:
  - Semantic M diff (Milestone 7) remains completely unstarted; any surprises in M parsing, AST shape, or canonicalization will be discovered late, closer to MVP, where they are more expensive to fix.
  - The current product only offers textual M diffs; competitors could close the gap on this basic capability while the flagship semantic query diff remains a paper design.
  - Later milestones that depend on M ASTs (semantic diff details, query signatures for rename detection, and possibly future PBIX/embedded scenarios) will have to be compressed into fewer cycles, increasing the chance of rushed or under‑tested implementations. 
  - The mismatch between the documented IR (`Query` with `ast` + `steps`) and the implemented IR (no AST/steps) will persist, increasing architecture drift and cognitive load for future contributors. 

references:
  - docs/rust_docs/excel_diff_testing_plan.md – Milestone 7 semantic M diffing and Phase 4 overview. 
  - docs/rust_docs/excel_diff_specification.md – Section 5.3 Power Query IR and Section 10.3 semantic M diff & canonicalization. 
  - docs/rust_docs/excel_diff_difficulty_analysis.md – H3 M parser & step model; H4 semantic M diff engine. 
  - docs/meta/excel_diff_meta_programming.md – Planner responsibilities and tests‑first cycle structure. 
  - codebase_context.md – Current `Query` and `m_diff` implementations (M5/M6 status). 

difficulty_estimate: 7
difficulty_reference: "10 = full H1 high-performance 2D grid diff engine (G8–G13, D1–D10) + adversarial/perf hardening as described in the testing plan and unified grid diff spec."
