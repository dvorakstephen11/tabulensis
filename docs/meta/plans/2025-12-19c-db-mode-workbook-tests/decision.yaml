# docs/meta/plans/2025-12-18-d2-d4-db-mode-workbook-tests/decision.yaml

work_type: milestone_progress
target_subsystem: database_mode_fixtures_and_workbook_tests
rationale:
  - "Phase 4 database-mode milestones D2-D4 require end-to-end workbook fixtures and assertions; current fixture-based coverage is centered on keyed equality (D1) and does not yet lock down add/remove/update semantics under real .xlsx parsing."
  - "The engine already has a dedicated keyed entrypoint (diff_grids_database_mode) and a db_keyed fixture generator; extending fixtures to model row updates and adding integration tests is the smallest cycle that materially increases confidence and prevents regressions."
  - "The current db_keyed generator can express extra rows (enabling D2 row-added) but cannot express in-place row updates (blocking D3 and D4 reorder+change), so fixture capability is the main limiting factor."
  - "Latest perf baselines are within enforced budgets for 50k-row scenarios; prioritizing correctness coverage for database mode now is lower-risk than chasing micro-optimizations, and it unblocks later work on duplicate-key clusters and mixed-mode sheets."
risks_of_deferral:
  - "Database-mode correctness could silently regress as parsing/IR and diff assembly evolve, because D2-D4 behavior would remain validated only by in-memory tests rather than real workbook fixtures."
  - "Without a fixture-backed contract for row updates and reorder+change, later database-mode expansions (duplicate-key clusters, key inference, mixed-region diffing) will have a weak baseline and higher debugging cost."
  - "Fixture generator limitations will continue to slow database-mode milestone progress by forcing ad-hoc test construction instead of declarative manifest scenarios."
references:
  - docs/rust_docs/excel_diff_testing_plan.md (Phase 4: D2-D4 database mode milestones)
  - docs/rust_docs/excel_diff_specification.md (Tabular Diff / Database Mode algorithm and duplicate-key cluster direction)
  - docs/rust_docs/unified_grid_diff_algorithm_specification.md (Database mode alignment section; keyed semantics)
  - core/src/engine.rs (diff_grids_database_mode)
  - fixtures/src/generators/database.py (KeyedTableGenerator / db_keyed)
difficulty_estimate:
  score: 3
  calibration:
    10: "H1: High-performance 2D grid diff engine (spreadsheet + database) including duplicate-key clusters and mixed-region diffing"
