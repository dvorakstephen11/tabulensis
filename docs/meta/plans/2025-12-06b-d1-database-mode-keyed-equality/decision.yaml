# docs/meta/plans/2025-12-06-d1-database-mode-keyed-equality/decision.yaml

branch: 2025-12-06-d1-database-mode-keyed-equality
work_type: milestone_progress
target_subsystem: grid_diff.database_mode
phase: "Phase 4 – Database-mode keyed diffs (D1)"
summary: >
  Implement the first database-mode keyed diff slice for unique-key tables and land
  the D1 “Keyed equality” milestone using the existing db_equal_ordered_{a,b} fixtures,
  without changing the default Spreadsheet Mode behavior of diff_workbooks.

rationale:
  - Database-mode keyed diffs (D1–D10) are called out as a core focus of Phase 4; D1
    “Keyed equality” is the smallest coherent slice that validates the database-mode
    design on real workbook fixtures.
  - The unified grid diff algorithm defines a separate database-mode pipeline
    (mode selection, key extraction, hash join) and UC-17 “Keyed rows, same keys
    different order”; implementing D1 exercises that path with minimal scope.
  - The current Rust engine only implements Spreadsheet Mode alignment
    (row/column anchoring, block moves, tail row/column adds); there is no
    database-mode entry point or key-aware alignment, so the database half of H1
    is still unimplemented.
  - Recent development history shows we have landed PG5 grid-diff baseline, PG6
    object-vs-grid behavior, row/column signatures, and robust DataMashup/M parsing,
    but no Phase 4 database-mode work yet; D1 is the natural next vertical slice.
  - The product differentiation plan leans heavily on “Database Mode (Keyed)” with
    hash-based alignment as a headline advantage versus incumbents that treat sheets
    purely positionally; landing D1 allows us to demonstrate that differentiator in
    practice.
  - The backlog and competitive-research todo emphasize database-style comparison and
    modern-Excel workloads (Power Query, large tabular exports); keyed equality on
    db_equal_ordered_{a,b} is the first concrete step toward that.
  - The meta-development guide requires each cycle to move a concrete testing milestone
    forward with explicit tests; wiring D1 into real fixtures and Rust tests fits that
    process cleanly.

risks_of_deferral:
  - Database Mode remains theoretical while Spreadsheet Mode matures, increasing the
    risk that later database-mode integration forces disruptive refactors to
    engine::diff_grids, DiffOp usage, or Grid/Workbook IR.
  - We postpone validating the keyed hash-join design on real Excel fixtures, so any
    performance, determinism, or API issues stay hidden until more of the engine
    depends on the existing grid-diff spine.
  - The D1–D10 database-mode milestones in the testing plan and the corresponding
    fixtures (db_equal_ordered_{a,b} and related generators) risk drifting out of sync
    with the implementation if we keep exercising only Spreadsheet Mode.
  - Database Mode is a key part of the differentiation story against incumbents focused
    on cell-wise grid comparison; delaying it weakens early demos and makes it harder
    to justify the engine’s added complexity and H1 difficulty.

references:
  - docs/rust_docs/excel_diff_testing_plan.md
  - docs/rust_docs/excel_diff_specification.md
  - docs/design/unified_grid_diff_algorithm_specification.md
  - docs/rust_docs/excel_diff_difficulty_analysis.md
  - docs/rust_docs/excel_diff_product_differentiation_plan.md
  - docs/rust_docs/excel_diff_meta_programming.md
  - docs/rust_docs/codebase_context.md
  - docs/rust_docs/development_history.txt

difficulty_estimate: 6
difficulty_reference: "10 = H1 “High-performance 2D grid diff engine (spreadsheet + database modes)” as scored in excel_diff_difficulty_analysis.md"

test_milestones:
  - "D1 – Keyed equality (Database Mode) in excel_diff_testing_plan.md"
  - "UC-17 – Keyed rows, same keys different order, in unified_grid_diff_algorithm_specification.md"

out_of_scope:
  - Key discovery/inference, composite keys, and duplicate-key cluster resolution
    (Hungarian/LAPJV) for D5–D9 / UC-19; this cycle assumes a single explicit unique
    key column provided by the caller/tests.
  - Mixed-sheet segmentation between database-table regions and free-form grid regions
    (D10 / UC-20); this cycle only operates on a single tabular region via direct
    Grid access.
  - Any behavior change to excel_diff::diff_workbooks or diff_workbooks_to_json;
    Database Mode remains an opt-in engine-level API for tests and future callers,
    not wired into the high-level workbook diff yet.
  - PBIX/PBIT tabular model diff and DAX-level database-mode semantics; this cycle
    only targets Excel Grid-based tables.
