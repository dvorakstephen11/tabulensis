# Decision Record: 2025-12-02-row-signatures-v1
# Paste decision YAML content here
work_type: incremental_milestone
branch: 2025-12-02-row-signatures-v1
target_subsystem: grid_preprocessing_row_col_signatures

rationale:
  - The unified grid diff spec treats row/column fingerprinting as the foundation of the AMR alignment pipeline (Phase 1: Preprocessing & Hashing, Sections 4.3 and 6.1–6.4). The current implementation only has a thin `RowSignature`/`ColSignature` wrapper over `DefaultHasher` and does not include row/column position in the hash, so it cannot safely support anchor-based alignment yet. 
  - `Grid::compute_row_signature` / `compute_col_signature` currently hash only `cell.value` and `cell.formula` via `DefaultHasher`, ignoring the column index for rows and the row index for columns. This means rows or columns with the same values in different positions can produce identical signatures, violating the spec’s “column/row position included” requirement and undermining future move/insert detection. 
  - Existing tests in `core/tests/signature_tests.rs` only assert “identical rows have same signature” and “different values produce different signatures”, but they do not cover column/row position sensitivity, type/tag behavior, or deterministic hash values. This leaves the most important fingerprint properties untested. 
  - The docs‑vs‑implementation review explicitly calls out row signatures as the top immediate priority (“Immediate: Enhance row signatures (column positions, type tags)”) before frequency analysis, Patience Diff, and the rest of the AMR pipeline. Addressing this now unblocks those higher‑risk milestones while PG5 grid diff and sheet identity are already in a healthy state. 
  - This work is tightly scoped: it touches only the Grid/signature layer and unit tests, without changing `DiffOp` JSON shape or `diff_grids` behavior. It is therefore well-suited to an incremental milestone that improves algorithmic readiness while keeping the external API stable.

risks_of_deferral:
  - Advanced grid alignment milestones (G8+ row/column alignment, frequency-based anchor discovery) will either be blocked or forced to build on weak, position-insensitive hashes, making it much harder to reason about correctness and performance later. 
  - The longer `DefaultHasher` and position-insensitive signatures remain, the more likely new code will start depending on their behavior implicitly. Retrofitting a stable, spec-compliant hash later would risk subtle regressions in any intermediate alignment experiments.
  - Spec drift will persist between `unified_grid_diff_algorithm_specification.md` and the implementation: the spec promises XXHash64/BLAKE3-based, position-aware hashing, while the code uses SipHash via `DefaultHasher` and omits position. This undermines trust in the docs and complicates future reviews. 
  - Without tests that lock in the intended semantics (e.g., swapped columns/rows must yield different signatures), refactors or performance tweaks could silently weaken fingerprint quality, compromising anchor selection and move detection once implemented.

references:
  - docs/rust_docs/unified_grid_diff_algorithm_specification.md – Part III: Preprocessing & Hashing (Sections 5.4, 6.2–6.4, 6.7–6.9). 
  - docs/rust_docs/excel_diff_specification.md – Section 9: Grid Diff (Spreadsheet Mode) overview and dependence on strong row signatures. :contentReference[oaicite:7]{index=7}
  - docs/rust_docs/2025-11-30-docs-vs-implementation.md – Part III: Preprocessing assessment and “Priority Order” table (Immediate: Enhance row signatures). :contentReference[oaicite:8]{index=8}
  - core/src/workbook.rs – current `Grid`, `RowSignature`, `ColSignature`, and `compute_*_signature` implementations. :contentReference[oaicite:9]{index=9}
  - core/tests/signature_tests.rs and core/tests/sparse_grid_tests.rs – existing signature behavior tests and `compute_all_signatures` coverage. 
  - docs/rust_docs/excel_diff_testing_plan.md – PG5 (in-memory grid diff) and the grid diff phases that will consume row/column hashes (Phase 4 alignment milestones). 

difficulty_estimate: 4
difficulty_scale_reference: "10 = H1. High-performance 2D grid diff engine (row/col alignment, block moves, database mode) from excel_diff_difficulty_analysis.md"
