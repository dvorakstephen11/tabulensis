cycle_id: "2025-11-28-cell-snapshots-pg3"
date: "2025-11-28"
branch_name: "2025-11-28-cell-snapshots-pg3"

work_type: "milestone_progress"

target_subsystem:
  - "workbook_sheet_grid_ir"
  - "cell_snapshot_ir"
  - "excel_open_xml_value_parsing"

target_testing_milestones:
  - "Phase 2 – PG3: Cell snapshots and comparison semantics" 
  - "Phase 2 – PG1/PG2 value semantics coverage (shared/inline strings, error cells)"

rationale:
  - >
    The core Workbook/Sheet/Grid IR and basic Excel parsing for PG1/PG2 are
    implemented and tested, but there is no `CellSnapshot` type or equality
    semantics anchored by tests, even though the technical doc assumes
    `DiffOp::CellEdited` carries snapshots. 
  - >
    The testing plan explicitly calls out PG3 “Cell snapshots and comparison
    semantics” (PG3.1–PG3.4) as the next grid-side milestone, including a
    dedicated fixture `pg3_value_and_formula_cells.xlsx` and a JSON
    round‑trip test for snapshots. 
  - >
    Recent verification for the container/grid cycle highlights a coverage gap
    around value semantics: shared/inline strings and error cells are parsed
    but not locked in by tests. This is a natural fit with PG3 since snapshots
    are the vehicle for value comparison. 
  - >
    Defining snapshot structure and equality now de-risks later work on
    DiffOp plumbing (PG4) and grid diff (PG5–G1..G7) by avoiding ad hoc
    representations of “cell state” in diff code. 
  - >
    The work is conceptually moderate: mostly IR shaping and test-heavy value
    semantics, with no algorithmic heavy lifting like grid alignment (H1) or
    semantic M diff (H4). This keeps the cycle small and well-scoped while
    still advancing a named milestone. 

risks_of_deferral:
  - >
    DiffOp design (PG4) and early grid-diff smoke tests (PG5) both assume a
    stable `CellSnapshot` payload. Deferring PG3 would force either speculative
    snapshot shapes or temporary hacks in diff code that will be expensive to
    unwind. 
  - >
    Without tests for shared/inline strings and error cells, subtle bugs in
    `convert_value` or inline/shared string handling may remain hidden until
    much later, when fixing them could change user-visible diff behavior. 
  - >
    The verification report already calls out value semantics as a gap; leaving
    it unresolved while building more layers on top increases overall risk and
    makes future debugging harder. 

references:
  architecture:
    - "excel_diff_technical_document.md – Diff pipeline and CellEdited/CellSnapshot context" 
  testing_plan:
    - "excel_diff_testing_plan.md – PG3 cell snapshots and comparison semantics" 
    - "excel_diff_testing_plan.md – PG4/PG5 expectations that depend on snapshots" 
  difficulty_and_risk:
    - "excel_diff_difficulty_analysis.md – H1/H2/H4 relative difficulty baseline" 
  implementation_state:
    - "codebase_context.md – current Workbook/Grid/Cell IR and value parsing in excel_open_xml.rs" 
    - "latest_test_results.txt – PG1/PG2 and DataMashup milestones passing; no PG3 tests yet"
  verification_reports:
    - "recent_verification_reports.txt – container/grid review, value semantics & used-range findings" 

difficulty_estimate:
  hardest_milestone_name: "H1 – High-performance 2D grid diff engine (row/col alignment, moves, DB mode)" 
  hardest_milestone_index: 10
  this_cycle_index: 3
  reasoning: >
    Implementing `CellSnapshot` and value semantics tests is mostly IR shaping,
    serde wiring, and fixture-driven tests on small workbooks. It touches the
    core IR and serialization surface (moderate system impact) but has low
    algorithmic and performance complexity compared to grid alignment or M AST
    diff.

deferred_items_addressed:
  - id: "VAL-001"
    description: >
      Introduce value-focused tests for shared/inline strings and error cells,
      tightening coverage around `convert_value` and related helpers.
    source: "Verification report for 2025-11-26 container/grid cycle – Missing Test / Coverage gap" 
    plan: >
      Add focused unit tests in `excel_open_xml.rs`’s test module that exercise
      shared-string rich text, inline strings with preserved whitespace,
      boolean `t=\"b\"` behavior, and error cells (`t=\"e\"`) and codify how
      they map into `CellValue`.

open_deferred_items_not_in_scope_this_cycle:
  - id: "USED-RANGE-001"
    description: >
      Tighten used-range semantics for sheets whose first used cell is not A1
      (possible grid origin or explicit used-range representation).
    note: >
      Remains open; will likely be handled as a small incremental milestone on
      top of PG1/PG2 to avoid conflating it with snapshot semantics. 
  - id: "ERRVAR-001"
    description: >
      Add explicit integration tests for `WorkbookXmlMissing` /
      `WorksheetXmlMissing` error variants.
    note: >
      Left for a later cycle focused on container error coverage to keep the
      present scope on values and snapshots.

notes_for_implementer_agent:
  - >
    Keep the new `CellSnapshot` type narrowly focused: address + value +
    formula, with a simple, well-documented equality rule. Formatting-aware
    semantics can be layered on later without changing the basic struct
    shape.
  - >
    JSON diff helpers (`CellDiff`, `serialize_cell_diffs`, `diff_workbooks`,
    `diff_workbooks_to_json`) are intentionally part of the core public
    surface, and `serde_json` is treated as a runtime dependency to support
    that output. Keep decision/spec documents aligned with this scope rather
    than implying test-only usage.
  - >
    When writing value semantics tests in `excel_open_xml.rs`, mirror the
    current behavior rather than pre-emptively changing it; if you decide to
    introduce a dedicated error-cell variant in `CellValue` in a later cycle,
    that should come with its own decision record and migration plan.
  - >
    JSON serialization failures currently map to `ExcelOpenError::XmlParseError`
    as the shared structured-text bucket for XML and JSON; if you split out a
    dedicated `JsonError` in the future, record that refinement in a follow-up
    decision entry.
