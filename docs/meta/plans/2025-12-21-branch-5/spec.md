Below is a concrete, repo-aware implementation plan for **Branch 5: Packaging & Distribution** (Windows + macOS + Web Demo + CI on release tags), aligned with the sprint plan’s deliverables and acceptance criteria. 

---

## What Branch 5 must ship

From `next_sprint_plan.md`, Branch 5 requires: 

* **Windows**: downloadable `.exe` from GitHub Releases + portable ZIP (+ optional MSI) + Scoop packaging
* **macOS**: downloadable binary that runs on **M1+**, plus **universal binary**, plus **Homebrew formula**, tested on **macOS Sequoia**
* **Web demo**: functional diff in-browser via WASM, deployed to **GitHub Pages** at `https://[user].github.io/excel_diff`
* **README**: installation instructions for all platforms
* **CI**: builds all platforms **on release tags**

---

## Phase 0: Prep work that will make packaging painless

### 0.1 Define one release “source of truth”

Pick the rule:

* Tag format: `vX.Y.Z` (e.g. `v0.1.0`)
* `cli/Cargo.toml` version must match that tag (and ideally `core/` too)

This enables deterministic artifact naming and avoids ambiguous builds.

### 0.2 Add/confirm minimal crate metadata (strongly recommended)

This is not explicitly listed in Branch 5, but it’s practically required for Homebrew/Scoop friendliness:

* `repository`, `homepage`, `license`, `description` in `cli/Cargo.toml` and `core/Cargo.toml`
* Ensure the binary name stays `excel-diff` (it already is in `cli/Cargo.toml` via `[[bin]] name = "excel-diff"`). 

### 0.3 Keep WASM size under control by feature-gating VBA parsing

Right now, the core crate couples `excel-open-xml` to `ovba` via features:

* `core/Cargo.toml` has `excel-open-xml = ["dep:ovba"]` 
* `open_vba_modules_from_container` directly calls `ovba::open_project(...)` 
* `WorkbookPackage::open(...)` always calls `open_vba_modules_from_container(...)` 

For the web demo, you want to be able to compile **OpenXML parsing** without dragging in VBA parsing (both for compatibility and bundle size). The sprint plan explicitly calls out WASM bundle size as a risk and suggests feature-gating. 

**Change plan:**

* In `core/Cargo.toml`:

  * Introduce a new feature: `vba = ["dep:ovba"]`
  * Make `excel-open-xml` *not* depend on `ovba`
  * Keep CLI default behavior the same by including `vba` in `default` features (or explicitly enabling it in the CLI dependency)

**Code plan:**

* In `core/src/excel_open_xml.rs`, split `open_vba_modules_from_container` into:

  * `#[cfg(feature = "vba")]` real implementation (current code)
  * `#[cfg(not(feature = "vba"))]` stub that returns `Ok(None)` without referencing `ovba`

This preserves current CLI functionality while enabling a lighter WASM build.

---

## Phase 1: Add the WASM crate + web demo assets

Branch 5 specifies a `wasm/` crate exporting wasm-bindgen APIs and a `web/` folder deployed to GitHub Pages. 

### 1.1 Workspace wiring

Workspace currently includes only `core` and `cli`. 
Update workspace members to include:

* `wasm`

### 1.2 Create `wasm/` crate: `excel_diff_wasm`

Goals:

* Compiles to `wasm32-unknown-unknown`
* Exposes one or two dead-simple entry points for the web UI

**Key design choice:** accept raw bytes for the two uploaded files.

Implementation sketch:

* `diff_report_json(old_bytes: &[u8], new_bytes: &[u8]) -> Result<String, JsValue>`

  * Wrap bytes in `std::io::Cursor`
  * Call `excel_diff::WorkbookPackage::open(cursor)` (it already accepts `Read+Seek`). 
  * Call `pkg_a.diff(&pkg_b, &DiffConfig::default())`
  * Serialize via `excel_diff::serialize_diff_report(...)`

**Dependency configuration:**

* Depend on `excel_diff` with:

  * `default-features = false`
  * `features = ["excel-open-xml"]`
* This ensures:

  * no filesystem APIs (`std-fs` off)
  * no VBA parsing unless you explicitly enable `vba`

### 1.3 Add `web/` frontend

As per the plan, create: 

```
web/
  index.html
  main.js
  wasm/  (generated by wasm-pack during CI)
```

Minimal UI behavior:

* Two `<input type="file">` elements
* “Diff” button
* Output area:

  * show counts (ops, sheets touched, etc.)
  * optionally show first N ops or provide a “download JSON” button

### 1.4 WASM build tooling choice

Use `wasm-pack` as requested. 

Recommended command in CI:

* `wasm-pack build wasm --release --target web --out-dir ../web/wasm`

Optional but useful:

* run `wasm-opt -O` on the `.wasm` output (if you decide size is a problem)

### 1.5 Update/extend existing WASM CI

You already have `.github/workflows/wasm.yml` which:

* builds `wasm_smoke` with `--no-default-features`
* enforces a **5MB** size budget

For Branch 5, add a second job (or extend) to:

* build the real `wasm/` package via `wasm-pack`
* enforce a separate budget for the web demo bundle (pick a budget that’s realistic, then tighten later)

---

## Phase 2: GitHub Pages deployment workflow for the web demo

Branch 5 requires the web demo live at `https://[user].github.io/excel_diff`. 

### 2.1 Add `.github/workflows/pages.yml`

Trigger:

* On push to `main` (so the demo stays current)
* Optionally also on release tags

Job steps:

1. Checkout
2. Install Rust + wasm target (`wasm32-unknown-unknown`)
3. Install `wasm-pack`
4. `wasm-pack build ... --out-dir web/wasm`
5. Upload Pages artifact from `web/`
6. Deploy via GitHub Pages actions

Repo settings needed (non-code):

* Pages Source: “GitHub Actions”
* Ensure the Pages environment is enabled

### 2.2 Verify base-path correctness

Because Pages will be served under `/excel_diff/`, ensure `main.js` uses **relative paths** when importing `./wasm/excel_diff_wasm.js`. That avoids hardcoding.

---

## Phase 3: Release workflow producing Windows + macOS artifacts

You currently have CI, perf, and wasm smoke workflows, but nothing that builds release artifacts on tag. 
Branch 5 wants a `release.yml` triggered by tags. 

### 3.1 Create `.github/workflows/release.yml`

Trigger:

* `push: tags: ["v*"]`

Core guarantees:

* Use `cargo build --release --locked -p excel_diff_cli`
* Produce deterministic artifact names based on tag

Recommended job structure:

#### Job A: Build Windows x64 + package ZIP

Runner: `windows-latest`

Steps:

* Build `excel-diff.exe`
* Create staging dir: `excel-diff-vX.Y.Z-windows-x86_64/`
* Copy:

  * `excel-diff.exe`
  * `README` (or a short `INSTALL.txt`)
  * `LICENSE` (if present)
* Zip it: `excel-diff-vX.Y.Z-windows-x86_64.zip`
* Compute sha256 for later (Scoop manifest + checksums)

#### Job B: Build macOS x64 artifact

Runner: mac runner that’s x86_64-capable (usually an older macOS runner)

Steps:

* Build `excel-diff`
* Package to `excel-diff-vX.Y.Z-macos-x86_64.tar.gz`
* Compute sha256

#### Job C: Build macOS arm64 artifact (M1+)

Runner: Apple Silicon runner

Steps:

* Build `excel-diff`
* Package to `excel-diff-vX.Y.Z-macos-arm64.tar.gz`
* Compute sha256

#### Job D: Create macOS universal binary

Runner: macOS (either arch is fine)

Steps:

* Download artifacts from Jobs B and C
* Run `lipo -create ... -output excel-diff`
* Optionally ad-hoc sign (`codesign -s -`) as a starter (the sprint plan suggests ad-hoc signing initially) 
* Package: `excel-diff-vX.Y.Z-macos-universal.tar.gz`
* Compute sha256 (this is the one Homebrew should reference)

#### Job E: Publish GitHub Release

Runner: ubuntu-latest

Steps:

* Download packaged artifacts
* Create GitHub Release for the tag
* Upload all assets:

  * Windows zip (+ optional MSI)
  * macOS arm64, x64, universal
  * checksums file
  * generated `excel-diff.rb` formula + `excel-diff.json` scoop manifest (more below)

This satisfies:

* “Windows .exe downloadable from GitHub Releases”
* “macOS binary downloadable and runs on M1+”
* “CI builds all platforms on release tags” 

### 3.2 Optional: MSI on Windows

If you do it, keep it strictly optional in the workflow (don’t block the main deliverables):

* Install WiX tooling
* Use `cargo-wix`
* Attach `.msi` as an extra asset

---

## Phase 4: Generate Homebrew + Scoop artifacts from the release

Branch 5 deliverables explicitly require:

* “Create Homebrew formula” 
* “Add to Scoop bucket” 

The cleanest approach is: **generate these files in the release workflow**, because they need the exact release URLs and sha256 values.

### 4.1 Homebrew formula generation

Target formula should download the **macOS universal tarball**.

Plan:

* Add a small script (Rust or Python) invoked in release job E that:

  * takes version + universal tarball sha256
  * outputs `excel-diff.rb`

Store it in-repo under something like:

* `packaging/homebrew/excel-diff.rb.in` (template)
* or generate fresh and upload as release asset

Distribution options:

* MVP simplest: ship formula as a release asset + README tells users how to use it
* Best practice: create a dedicated tap repo (`homebrew-excel-diff`) and publish the formula there (may be a follow-up operational step)

### 4.2 Scoop manifest generation

Similarly generate:

* `excel-diff.json` pointing at the Windows ZIP asset + sha256

Distribution options:

* MVP: ship manifest as release asset + README explains installing from a custom bucket
* Best practice: create your own Scoop bucket repo and/or submit to Scoop main bucket

---

## Phase 5: README updates (installation + web demo)

Branch 5 acceptance explicitly requires install instructions in README for all platforms. 

Add a top-level “Install” section with:

### Windows

* Download ZIP from GitHub Releases
* Unzip
* Add folder to PATH
* Optional: Scoop instructions if you publish a bucket

### macOS

* Homebrew (preferred): tap + install (or local formula usage)
* Manual: download universal tar.gz, extract, move `excel-diff` into `/usr/local/bin` or `~/.local/bin`

Also include a short troubleshooting note about Gatekeeper/quarantine if needed.

### Web demo

* Link to GitHub Pages URL (`/excel_diff`)
* Explain: runs fully in-browser, no upload

### Build from source

Even if you ship binaries, it’s useful:

* `cargo install --path cli`
* or `cargo build --release -p excel_diff_cli`

---

## Phase 6: Testing/verification checklist (what to validate before calling Branch 5 “done”)

### 6.1 Release workflow validation (pre-tag)

Before tagging a real release:

* Add `workflow_dispatch` to `release.yml` so you can dry-run artifact builds without publishing
* Confirm you can download artifacts from the Actions run and execute them locally

### 6.2 Platform smoke tests

In CI (fast):

* `excel-diff --version`
* `excel-diff --help`

On macOS Sequoia specifically (deliverable): run the arm64 build (or universal) on a Sequoia runner and confirm it executes. 

### 6.3 Web demo test matrix

Manually test a few cases:

* tiny `.xlsx` (few cells)
* medium workbook
* larger file (to find performance/memory issues early)

And confirm the existing WASM smoke workflow continues to pass (it currently enforces the 5MB budget on `wasm_smoke.wasm`).

---

## Concrete file-by-file change list

This is the “what you’ll actually touch” list.

### New / modified Rust workspace files

* `Cargo.toml` (workspace): add `wasm` member 
* `core/Cargo.toml`: split features to decouple `excel-open-xml` from `ovba` 
* `core/src/excel_open_xml.rs`: gate `open_vba_modules_from_container` behind new `vba` feature 
* `wasm/Cargo.toml`, `wasm/src/lib.rs`: wasm-bindgen exports (new) 
* `.gitignore`: ignore `web/wasm/` output (recommended) 

### New web assets

* `web/index.html`, `web/main.js` 

### New CI workflows

* `.github/workflows/release.yml` (new): builds Windows + macOS + publishes release 
* `.github/workflows/pages.yml` (new): builds wasm + deploys `web/` to Pages 
* `.github/workflows/wasm.yml` (edit): add web-demo wasm build and/or a second size budget

### Packaging templates

* `packaging/homebrew/excel-diff.rb.in` (template) or generated formula
* `packaging/scoop/excel-diff.json.in` (template) or generated manifest

### Documentation

* `README.md`: install instructions + web demo link 

---

## Why this plan fits your current codebase

* The library already opens workbooks from any `Read+Seek` reader (`WorkbookPackage::open`), which maps cleanly to browser uploads via `Cursor<Vec<u8>>`. 
* WASM support already exists in CI (smoke build + enforced size budget), so extending it to build the real web demo is a natural incremental step.
* Feature-gating VBA parsing is directly supported by how VBA is currently loaded (one function that calls `ovba::open_project`), making it a low-risk refactor that helps the web deliverable.

---

If you want, I can also produce an “exact workflow design” (job names, artifact naming convention, and the specific handoff between mac x64/arm64 → universal → release upload) that matches your existing CI style (`dtolnay/rust-toolchain@stable`, Python already present in CI, etc.). 
